name: BE CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    if: startsWith(github.event.head_commit.message, '[BE]')
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

      - name: ë°°í¬ ì§„í–‰ ì¤‘ ì•Œë¦¼
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":hourglass_flowing_sand: *MoneyMinder ì„œë²„ ë°°í¬ë¥¼ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...*"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n`{{ author }} ğŸ§‘â€ğŸ’»`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`{{ commit }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Message:*\n{{ message }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Ref:*\n`{{ ref }} ğŸ·ï¸`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Pull Request:*\n`{{ pullRequest }}`"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ë°°í¬ ì‘ì—… ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ğŸš€"
                  }
                ]
              }
            ]
          }' $SLACK_WEBHOOK_URL

      - name: Gradle ë¹Œë“œ
        working-directory: backend
        run: ./gradlew build

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‰¬
        run: |
          docker build --platform linux/amd64 -t gangeunlee/moneyminder-backend:latest -f config/deploy/be-Dockerfile .
          docker push gangeunlee/moneyminder-backend:latest

      - name: íŒŒì¼ ì „ì†¡
        uses: appleboy/scp-action@master
        with:
          username: ${{ secrets.EC2_USER }}
          host: ${{ secrets.EC2_HOST }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: config/deploy
          target: /home/${{ secrets.EC2_USER }}/moneyminder/

      - name: EC2ì— í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ë° deploy.sh íŒŒì¼ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.EC2_USER }}/moneyminder/config/deploy
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • íŒŒì¼ ìƒì„±
            echo "SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}" > .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "SPRING_REDIS_HOST=${{ secrets.SPRING_REDIS_HOST }}" >> .env
            echo "SPRING_REDIS_PORT=${{ secrets.SPRING_REDIS_PORT }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_ID=${{ secrets.NAVER_OAUTH2_CLIENT_ID }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_SECRET=${{ secrets.NAVER_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "AUTH_TOKEN_SECRET_KEY=${{ secrets.AUTH_TOKEN_SECRET_KEY }}" >> .env
            echo "MAIL_USER_NAME=${{ secrets.MAIL_USER_NAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

            # deploy.sh ì‹¤í–‰
            chmod +x deploy.sh
            ./deploy.sh

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "> :green_heart: *MoneyMinder ì„œë²„ ë°°í¬ ì„±ê³µ!*"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n`{{ author }} ğŸ§‘â€ğŸ’»`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`{{ commit }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Message:*\n{{ message }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Ref:*\n`{{ ref }} ğŸ·ï¸`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Pull Request:*\n`{{ pullRequest }}`"
                  }
                ]
              }
            ]
          }' $SLACK_WEBHOOK_URL

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "> :x: *MoneyMinder ì„œë²„ ë°°í¬ ì‹¤íŒ¨!*"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n`{{ author }} ğŸ§‘â€ğŸ’»`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`{{ commit }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Message:*\n{{ message }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Ref:*\n`{{ ref }} ğŸ·ï¸`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Pull Request:*\n`{{ pullRequest }}`"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ë°°í¬ ì‹¤íŒ¨: :warning: `{{ workflow }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "ì†Œìš” ì‹œê°„: `{{ took }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "ë¬¸ì œ ì›ì¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤. ğŸ”"
                  }
                ]
              }
            ]
          }' $SLACK_WEBHOOK_URL
