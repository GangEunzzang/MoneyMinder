name: BE CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    if: startsWith(github.event.head_commit.message, '[BE]')
    runs-on: ubuntu-latest

    steps:
      ########################################################
      # 1) ì²´í¬ì•„ì›ƒ & í™˜ê²½ ì¤€ë¹„
      ########################################################
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

      ########################################################
      # 2) ë°°í¬ ì§„í–‰ ì¤‘ ì•Œë¦¼ (ë°°í¬ ì‹œì‘ ì‹œ)
      ########################################################
      - name: Deploy in progress (Slack)
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":hourglass_flowing_sand: *MoneyMinder ì„œë²„ ë°°í¬ë¥¼ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} ğŸ§‘â€ğŸ’»`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} ğŸ·ï¸`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ë°°í¬ ì‘ì—… ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. ğŸš€"
                    }
                  ]
                }
              ]
            }

      ########################################################
      # 3) ì‹¤ì œ ë¹Œë“œ ë° Docker ì‘ì—…
      ########################################################
      - name: Gradle ë¹Œë“œ
        working-directory: backend
        run: ./gradlew build

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‰¬
        run: |
          docker build --platform linux/amd64 -t gangeunlee/moneyminder-backend:latest -f config/deploy/be-Dockerfile .
          docker push gangeunlee/moneyminder-backend:latest

      ########################################################
      # 4) SSHë¥¼ í†µí•´ ì„œë²„ì— ë°°í¬ íŒŒì¼ ì „ì†¡ ë° deploy.sh ì‹¤í–‰
      ########################################################
      - name: íŒŒì¼ ì „ì†¡
        uses: appleboy/scp-action@master
        with:
          username: ${{ secrets.EC2_USER }}
          host: ${{ secrets.EC2_HOST }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: config/deploy
          target: /home/${{ secrets.EC2_USER }}/moneyminder/

      - name: EC2ì— í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ë° deploy.sh íŒŒì¼ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.EC2_USER }}/moneyminder/config/deploy
            echo "SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}" > .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "SPRING_REDIS_HOST=${{ secrets.SPRING_REDIS_HOST }}" >> .env
            echo "SPRING_REDIS_PORT=${{ secrets.SPRING_REDIS_PORT }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_ID=${{ secrets.NAVER_OAUTH2_CLIENT_ID }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_SECRET=${{ secrets.NAVER_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "AUTH_TOKEN_SECRET_KEY=${{ secrets.AUTH_TOKEN_SECRET_KEY }}" >> .env
            echo "MAIL_USER_NAME=${{ secrets.MAIL_USER_NAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

            chmod +x deploy.sh
            ./deploy.sh

      ########################################################
      # 5) ë°°í¬ ì„±ê³µ ì•Œë¦¼
      ########################################################
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼ (Slack)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "> :green_heart: *MoneyMinder ì„œë²„ ë°°í¬ ì„±ê³µ!*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} ğŸ§‘â€ğŸ’»`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} ğŸ·ï¸`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ ì‘ì—… ì™„ë£Œ* :white_check_mark:"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì—… ì†Œìš” ì‹œê°„:* `${{ steps.took.outputs.time || '??' }}`"
                    }
                  ]
                }
              ]
            }

      ########################################################
      # 6) ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      ########################################################
      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ (Slack)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "> :x: *MoneyMinder ì„œë²„ ë°°í¬ ì‹¤íŒ¨!*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} ğŸ§‘â€ğŸ’»`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} ğŸ·ï¸`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ ì‘ì—… ì™„ë£Œ* :warning:"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì—… ì†Œìš” ì‹œê°„:* `${{ steps.took.outputs.time || '??' }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "ë¬¸ì œ ì›ì¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤. ğŸ”"
                    }
                  ]
                }
              ]
            }

