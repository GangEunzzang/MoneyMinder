name: BE CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    if: startsWith(github.event.head_commit.message, '[BE]')
    runs-on: ubuntu-latest

    steps:
      ########################################################
      # 1) Ï≤¥ÌÅ¨ÏïÑÏõÉ & ÌôòÍ≤Ω Ï§ÄÎπÑ
      ########################################################
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JDK 17 ÏÑ§Ïπò
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

      ########################################################
      # 2) Î∞∞Ìè¨ ÏßÑÌñâ Ï§ë ÏïåÎ¶º (Î∞∞Ìè¨ ÏãúÏûë Ïãú)
      ########################################################
      - name: Deploy in progress (Slack)
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":hourglass_flowing_sand: *MoneyMinder ÏÑúÎ≤Ñ Î∞∞Ìè¨Î•º ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§...*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} üßë‚Äçüíª`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} üè∑Ô∏è`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Î∞∞Ìè¨ ÏûëÏóÖ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî. üöÄ"
                    }
                  ]
                }
              ]
            }

      ########################################################
      # 3) Ïã§Ï†ú ÎπåÎìú Î∞è Docker ÏûëÏóÖ
      ########################################################
      - name: Gradle ÎπåÎìú
        working-directory: backend
        run: ./gradlew build

      - name: Docker Hub Î°úÍ∑∏Ïù∏
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Î∞±ÏóîÎìú Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïâ¨
        run: |
          docker build --platform linux/amd64 -t gangeunlee/moneyminder-backend:latest -f config/deploy/be-Dockerfile .
          docker push gangeunlee/moneyminder-backend:latest

      ########################################################
      # 4) SSHÎ•º ÌÜµÌï¥ ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨ ÌååÏùº Ï†ÑÏÜ° Î∞è deploy.sh Ïã§Ìñâ
      ########################################################
      - name: ÌååÏùº Ï†ÑÏÜ°
        uses: appleboy/scp-action@master
        with:
          username: ${{ secrets.EC2_USER }}
          host: ${{ secrets.EC2_HOST }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: config/deploy
          target: /home/${{ secrets.EC2_USER }}/moneyminder/

      - name: EC2Ïóê ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏÉùÏÑ± Î∞è deploy.sh ÌååÏùº Ïã§Ìñâ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.EC2_USER }}/moneyminder/config/deploy
            echo "SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}" > .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "SPRING_REDIS_HOST=${{ secrets.SPRING_REDIS_HOST }}" >> .env
            echo "SPRING_REDIS_PORT=${{ secrets.SPRING_REDIS_PORT }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_ID=${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}" >> .env
            echo "GOOGLE_OAUTH2_CLIENT_SECRET=${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_ID=${{ secrets.NAVER_OAUTH2_CLIENT_ID }}" >> .env
            echo "NAVER_OAUTH2_CLIENT_SECRET=${{ secrets.NAVER_OAUTH2_CLIENT_SECRET }}" >> .env
            echo "AUTH_TOKEN_SECRET_KEY=${{ secrets.AUTH_TOKEN_SECRET_KEY }}" >> .env
            echo "MAIL_USER_NAME=${{ secrets.MAIL_USER_NAME }}" >> .env
            echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> .env

            chmod +x deploy.sh
            ./deploy.sh

      ########################################################
      # 5) Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
      ########################################################
      - name: Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º (Slack)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "> :green_heart: *MoneyMinder ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏÑ±Í≥µ!*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} üßë‚Äçüíª`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} üè∑Ô∏è`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*Î∞∞Ìè¨ ÏûëÏóÖ ÏôÑÎ£å* :white_check_mark:"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ÏûëÏóÖ ÏÜåÏöî ÏãúÍ∞Ñ:* `${{ steps.took.outputs.time || '??' }}`"
                    }
                  ]
                }
              ]
            }

      ########################################################
      # 6) Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º
      ########################################################
      - name: Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º (Slack)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "> :x: *MoneyMinder ÏÑúÎ≤Ñ Î∞∞Ìè¨ Ïã§Ìå®!*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n`${{ github.actor }} üßë‚Äçüíª`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.head_commit.id }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Message:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ref:*\n`${{ github.ref }} üè∑Ô∏è`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n`${{ github.event.pull_request.number || 'N/A' }}`"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "*Î∞∞Ìè¨ ÏûëÏóÖ ÏôÑÎ£å* :warning:"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ÏûëÏóÖ ÏÜåÏöî ÏãúÍ∞Ñ:* `${{ steps.took.outputs.time || '??' }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "Î¨∏Ï†ú ÏõêÏù∏ Î∂ÑÏÑùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. üîç"
                    }
                  ]
                }
              ]
            }

